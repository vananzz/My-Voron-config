[include fluidd.cfg]

[include klicky-probe.cfg]

[include macros.cfg]

[pause_resume]

[display_status]

[exclude_object]

[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_1F003A000A51323332353039-if00

[printer]
kinematics: corexy
max_velocity: 150
max_accel: 2000   			#Max 4000
max_z_velocity: 5 			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 10
square_corner_velocity: 5.0

[stepper_x]
step_pin:PC14
dir_pin:PC13
enable_pin:!PC15
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200
endstop_pin:PA14
position_min: 0
position_endstop: 299
position_max: 300

#--------------------------------------------------------------------
homing_speed:50
homing_retract_dist:5
homing_positive_dir:true

[stepper_y]
step_pin:PE5
dir_pin:PE4
enable_pin:!PC15
microsteps:16
rotation_distance: 40
full_steps_per_rotation:200
endstop_pin:PA15
position_min: 0
position_endstop:300
position_max:300

#--------------------------------------------------------------------
homing_speed:50
homing_retract_dist:0
homing_positive_dir:true

[stepper_z]
step_pin:PE1
dir_pin:PE0
enable_pin: !PE2
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16
endstop_pin:PB13
position_endstop: 2
position_max: 230
position_min: -15 
homing_speed: 3
second_homing_speed: 3

[stepper_z1]
step_pin:PD6
dir_pin:!PD5
enable_pin:!PD7
microsteps:16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16

[stepper_z2]
step_pin:PD2
dir_pin:PD1
enable_pin:!PD3
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16

[stepper_z3]
step_pin:PC7
dir_pin:!PC6
enable_pin:!PC8
microsteps:16
rotation_distance:40
full_steps_per_rotation: 200
gear_ratio:80:16


[extruder]
step_pin:PB5
dir_pin:!PB4
enable_pin:!PB6
microsteps:16
rotation_distance: 4.637
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_temp: 275
heater_pin: PB1
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC1
max_power: 1.0
control : pid  
pid_kp : 31.093 
pid_ki : 1.956
pid_kd : 123.594
pressure_advance: 0.05 
pressure_advance_smooth_time: 0.040
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
min_extrude_temp: 200

[heater_bed]
heater_pin: PB0
sensor_type: Generic 3950
sensor_pin: PC0
max_power: 0.48
control = pid
pid_kp = 29.488
pid_ki = 0.998
pid_kd = 217.840
min_temp: 0
max_temp: 200

#part cooling fan
[fan]
pin: PA1

[heater_fan my_nozzle_fan]
pin: PA0
shutdown_speed: 1

# [controller_fan chamber_fan]
# pin: PA2

[idle_timeout]
timeout: 3600

[quad_gantry_level]
gantry_corners:
	-60,-10
	360,370
##	Probe points
points:
	50,25
	50,225
	250,225
	250,25
speed: 80
retries: 5
retry_tolerance: 0.0075
max_adjust: 310

[probe]
pin:PB12
x_offset: 0.8
y_offset: 26.5
z_offset: -0.562500
speed: 10.0
samples: 2
samples_result: average
sample_retract_dist: 3.0
samples_tolerance: 0.0075
samples_tolerance_retries: 2

## Auto Z Configuration
# Measure the offset of your probe from the nozzle and update accordingly. 
# These numbers work with PCB Klicky and the stock hotend. 
# Note that you want to probe on the switch body, not the switch itself, so the switch position will be different that the probe offsets.
# You need to install the Auto Z plugin in order for this to work.
# SSH into your Klipper host and execute the following commands
# cd /home/pi
# git clone https://github.com/protoloft/klipper_z_calibration.git
# ./klipper_z_calibration/install.sh

[z_calibration]
nozzle_xy_position: 96.7, 300   #<X,Y position for clicking the nozzle on the Z endstop>
switch_xy_position: 97.5, 273.5   #<X,Y position for clicking the probe's switch body on the Z endstop>
bed_xy_position: 150, 150     #<X,Y position for probing the bed, for instance the center point>
# Update switch_offset according to your probe type. This value worked for me with PCB Klicky (Omron A201 Plunger-Style Limit Switch)
# Increase switch_offset for more squish, reduce for less
switch_offset: 0.4        #<offset of the switch trigger (read the Switch Offset section!)>
start_gcode: ATTACH_PROBE          #<macro name for attaching the probe>
#before_switch_gcode: #<macro name for attaching the probe AFTER probing the nozzle>
end_gcode: DOCK_PROBE            #<macro name for docking the probe>

[bed_mesh]
speed: 80
mesh_min: 1.8, 53
mesh_max: 300.8, 296.5
probe_count: 5, 5

#####################################################################
# LED Control
#####################################################################

#[output_pin caselight ](Use PA9)
##  Chamber Lighting - In 5V-RGB Position
#pin: PA9
#pwm: true
#shutdown_value: 0
#value:100
#cycle_time: 0.01

########################################
# TMC UART configuration
########################################

[tmc2209 stepper_x]
uart_pin: PE6
interpolate: True
run_current: 0.8
hold_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 9999

[tmc2209 stepper_y]
uart_pin: PE3
interpolate: True
run_current: 0.8
hold_current: 0.3
sense_resistor: 0.110
stealthchop_threshold: 9999

[tmc2209 stepper_z]
uart_pin: PB7
interpolate: True
run_current: 0.8
hold_current: 0.5
stealthchop_threshold: 9999

[tmc2209 extruder]
uart_pin: PB3
interpolate: True
run_current: 0.85
hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 9999
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4

[tmc2209 stepper_z1]
uart_pin: PD4
interpolate: True
run_current: 0.8
hold_current: 0.5
stealthchop_threshold: 9999

[tmc2209 stepper_z2]
uart_pin: PD0
interpolate: True
run_current: 0.8
hold_current: 0.5
stealthchop_threshold: 9999

[tmc2209 stepper_z3]
uart_pin: PD15
interpolate: True
run_current: 0.8
hold_current: 0.5
stealthchop_threshold: 9999
